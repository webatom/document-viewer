import{$ as le,A as w,B as I,C as O,D as N,E as z,F as R,G as l,H as q,I as U,J as m,K as oe,L as H,M as X,N as B,O as ie,P as re,R as p,U as ae,X as se,Z as ce,a as D,aa as ue,b as F,ba as de,c as Y,ca as me,d as G,e as J,f as S,g as K,h as Q,i as W,j as L,k as f,l as c,m as v,n as b,o as _,p as P,q as d,r as E,s as ee,t as te,u as V,v as Z,w as k,x as h,y as x,z as ne}from"./chunk-6GGR7BBN.js";var y=class o{state$$=new G({document:null,hasDocumentError:!1,isDocumentLoading:!1,annotationsRecord:{}});state$=this.state$$.asObservable();setIsDocumentLoading(e){this.updateState({isDocumentLoading:e})}setHasDocumentError(e){this.updateState({hasDocumentError:e})}setDocument(e){this.updateState({document:e})}addAnnotation(e){let t=structuredClone(this.state$$.value.annotationsRecord),n=t[e.pageNumber]??null;n?t[e.pageNumber]=n.concat(e):t[e.pageNumber]=[e],this.updateState({annotationsRecord:t})}changeAnnotation(e,t,{x:n,y:i,text:r}){let a=structuredClone(this.state$$.value.annotationsRecord),u=a[e]??null;u&&(a[e]=u.map(s=>s.id===t?F(D({},s),{x:n??s.x,y:i??s.y,text:r??s.text}):s),this.updateState({annotationsRecord:a}))}deleteAnnotation(e,t){let n=structuredClone(this.state$$.value.annotationsRecord),i=n[e]??null;i&&(n[e]=i.filter(r=>r.id!==t),this.updateState({annotationsRecord:n}))}updateState(e){this.state$$.next(D(D({},this.state$$.value),e))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=f({token:o,factory:o.\u0275fac})};function pe(o){o||(o=c(_));let e=new Y(t=>{if(o.destroyed){t.next();return}return o.onDestroy(t.next.bind(t))});return t=>t.pipe(W(e))}function M(o,e){let n=!e?.manualCleanup?e?.injector?.get(_)??c(_):null,i=Ce(e?.equal),r;e?.requireSync?r=P({kind:0},{equal:i}):r=P({kind:1,value:e?.initialValue},{equal:i});let a,u=o.subscribe({next:s=>r.set({kind:1,value:s}),error:s=>{r.set({kind:2,error:s}),a?.()},complete:()=>{a?.()}});if(e?.requireSync&&r().kind===0)throw new L(601,!1);return a=n?.onDestroy(u.unsubscribe.bind(u)),p(()=>{let s=r();switch(s.kind){case 1:return s.value;case 2:throw s.error;case 0:throw new L(601,!1)}},{equal:e?.equal})}function Ce(o=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&o(e.value,t.value)}var g=256,fe=[],ge=256,T;for(;g--;)fe[g]=(g+256).toString(16).substring(1);function ve(o){var e=0,t=o||11;if(!T||g+t>ge*2)for(T="",g=0;e<ge;e++)T+=fe[Math.random()*256|0];return T.substring(g,g+++t)}var A=class o{documentsApi=c(se);annotationsApiService=c(ce);activatedRoute=c(ae);documentPageStore=c(y);destroyRef=c(_);pageState$=this.documentPageStore.state$;document=M(this.pageState$.pipe(S(({document:e})=>e)),{initialValue:null});hasError=M(this.pageState$.pipe(S(({hasDocumentError:e})=>e)),{initialValue:!1});isLoading=M(this.pageState$.pipe(S(({isDocumentLoading:e})=>e)),{initialValue:!1});annotationsRecord=M(this.pageState$.pipe(S(({annotationsRecord:e})=>e)));init(){let e=this.activatedRoute.snapshot.paramMap.get("id");if(!e){console.error("The `documentName` param not found"),this.documentPageStore.setHasDocumentError(!0);return}this.loadDocument(e)}addAnnotation(e,{x:t,y:n}){this.documentPageStore.addAnnotation({id:ve(),pageNumber:e,text:"",x:t,y:n})}changeAnnotationPosition(e,t,{x:n,y:i}){this.documentPageStore.changeAnnotation(e,t,{x:n,y:i})}changeAnnotationText(e,t,n){this.documentPageStore.changeAnnotation(e,t,{text:n})}deleteAnnotation(e,t){this.documentPageStore.deleteAnnotation(e,t)}saveAnnotations(){this.annotationsApiService.save(this.getAnnotationList())}getAnnotationList(){let e=this.annotationsRecord();return e?Object.values(e).flatMap(t=>t):[]}loadDocument(e){this.documentPageStore.setIsDocumentLoading(!0),this.documentsApi.getById(e).pipe(K(t=>(console.error("Error fetch document",t),this.documentPageStore.setHasDocumentError(!0),J(null))),Q(()=>{this.documentPageStore.setIsDocumentLoading(!1)}),pe(this.destroyRef)).subscribe(t=>{this.documentPageStore.setDocument(t),t&&this.documentPageStore.setHasDocumentError(!1)})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=f({token:o,factory:o.\u0275fac})};var C=class o{zoom=P(70);zoomValue=this.zoom.asReadonly();isAlreadyMin=p(()=>this.zoom()===30);isAlreadyMax=p(()=>this.zoom()===150);increment(){this.zoom.update(e=>Math.min(e+10,150))}decrement(){this.zoom.update(e=>Math.max(e-10,30))}setDefault(){this.zoom.set(70)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var j=class o{zoomService=c(C);zoomValue=this.zoomService.zoomValue;isDisableIncrement=this.zoomService.isAlreadyMax;isDisableDecrement=this.zoomService.isAlreadyMin;zoomIn(){this.zoomService.increment()}zoomOut(){this.zoomService.decrement()}resetZoom(){this.zoomService.setDefault()}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=E({type:o,selectors:[["zoom-controller"]],decls:8,vars:3,consts:[["type","button","title","Reset","tabindex","0",1,"control",3,"click"],["type","button","tabindex","0","title","Decrement",1,"control",3,"click","disabled"],[1,"value"],["type","button","tabindex","0","title","Increment",1,"control",3,"click","disabled"]],template:function(t,n){t&1&&(w(0,"button",0),R("click",function(){return n.resetZoom()}),m(1,` Reset
`),I(),w(2,"button",1),R("click",function(){return n.zoomOut()}),m(3,` -
`),I(),w(4,"span",2),m(5),I(),w(6,"button",3),R("click",function(){return n.zoomIn()}),m(7,` +
`),I()),t&2&&(d(2),N("disabled",n.isDisableDecrement()),d(3),oe(n.zoomValue()),d(),N("disabled",n.isDisableIncrement()))},styles:["[_nghost-%COMP%]{display:flex;align-items:center;color:gray;gap:4px;-webkit-user-select:none;user-select:none}.value[_ngcontent-%COMP%]{display:inline-flex;justify-content:center;align-items:center;background-color:#fafafa;height:28px;width:36px;font-weight:700;font-size:20px;border:1px solid gray}.control[_ngcontent-%COMP%]{min-width:28px;height:30px;border:1px solid gray;cursor:pointer}.control[_ngcontent-%COMP%]:disabled{cursor:not-allowed;opacity:.8;background-color:gray}"]})};var Se=()=>[],Pe=(o,e)=>e.number,we=(o,e)=>e.id;function Ie(o,e){o&1&&m(0,` Document is loading...
`)}function Me(o,e){o&1&&m(0,` Error (see logs)
`)}function Ae(o,e){if(o&1){let t=O();h(0,"annotation",9),z("dragEnd",function(i){let r=v(t).$implicit,a=l().$implicit,u=l(2);return b(u.onAnnotationPositionChange(a.number,r.id,i))})("textChange",function(i){let r=v(t).$implicit,a=l().$implicit,u=l(2);return b(u.onAnnotationTextChange(a.number,r.id,i))})("delete",function(){let i=v(t).$implicit,r=l().$implicit,a=l(2);return b(a.onAnnotationDelete(r.number,i.id))}),x()}if(o&2){let t=e.$implicit;l();let n=q(1);l();let i=B(5);U("transform",`scale(${i})`),k("annotation",t)("container",n)}}function Ee(o,e){if(o&1){let t=O();h(0,"div",6,0)(2,"page-viewer",7),z("dblclick",function(i){let r=v(t).$implicit,a=q(1),u=l(2);return b(u.onPageDoubleClick(i,r.number,a))}),x(),V(3,Ae,1,4,"annotation",8,we),x()}if(o&2){let t,n=e.$implicit;d(2),k("page",n);let i=((t=l(2).annotationsRecord())==null?null:t[n.number])??re(1,Se);d(),Z(i)}}function ke(o,e){if(o&1){let t=O();h(0,"toolbar",1)(1,"div",2),ne(2,"zoom-controller"),h(3,"button",3),z("click",function(){v(t);let i=l();return b(i.onSaveAnnotations())}),m(4," Save "),x()()(),H(5),h(6,"main",4)(7,"div",5),V(8,Ee,5,2,"div",6,Pe),x()()}if(o&2){let t=l(),n=B(0);k("title",n.name),d(5);let i=X(t.zoomInPercent());d(2),U("width",i),d(),Z(n.pages)}}var ye=class o{documentPageService=c(A);zoomService=c(C);document=this.documentPageService.document;isLoading=this.documentPageService.isLoading;hasError=this.documentPageService.hasError;annotationsRecord=this.documentPageService.annotationsRecord;zoomInPercent=p(()=>`${this.zoomService.zoomValue()}%`);ngOnInit(){this.documentPageService.init()}onPageDoubleClick(e,t,n){let i=n.getBoundingClientRect(),r=e.clientX-i.left,a=e.clientY-i.top;this.documentPageService.addAnnotation(t,{x:r/i.width*100,y:a/i.height*100})}onSaveAnnotations(){this.documentPageService.saveAnnotations()}onAnnotationPositionChange(e,t,n){this.documentPageService.changeAnnotationPosition(e,t,n.position)}onAnnotationTextChange(e,t,n){this.documentPageService.changeAnnotationText(e,t,n)}onAnnotationDelete(e,t){this.documentPageService.deleteAnnotation(e,t)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=E({type:o,selectors:[["document-page"]],features:[ie([A,y])],decls:4,vars:2,consts:[["pageContainer",""],[3,"title"],["actions","",1,"toolbar-actions"],["type","button","title","Save","tabindex","0",1,"save-btn",3,"click"],[1,"document-viewer"],[1,"document-viewer__viewport"],[1,"page-container"],[3,"dblclick","page"],["draggable","",1,"page-annotation",3,"transform","annotation","container"],["draggable","",1,"page-annotation",3,"dragEnd","textChange","delete","annotation","container"]],template:function(t,n){if(t&1&&(H(0),ee(1,Ie,1,0)(2,Me,1,0)(3,ke,10,4)),t&2){let i=X(n.document());d(),te(n.isLoading()?1:n.hasError()?2:i?3:-1)}},dependencies:[le,ue,j,me,de],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;height:100vh}.document-viewer[_ngcontent-%COMP%]{height:100%;padding:24px 0;overflow:auto;background-color:#d3d3d3}.document-viewer__viewport[_ngcontent-%COMP%]{gap:16px;margin:auto;transition:width .2s ease}.toolbar-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.page-container[_ngcontent-%COMP%]{position:relative;margin:0 16px 16px}.page-annotation[_ngcontent-%COMP%]{--annotation-transition: transform .2 opacity .2 ease box-shadow .2 ease;transform-origin:0px 0px}.save-btn[_ngcontent-%COMP%]{height:30px;background-color:#90ee90;border:1px solid gray;cursor:pointer}"]})};export{ye as DocumentPageComponent};
